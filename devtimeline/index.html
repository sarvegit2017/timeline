<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <base target="_top">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f6f6f6;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
    }

    .subtitle {
      text-align: center;
      color: #555;
      margin-bottom: 24px;
    }

    .timeline-section {
      margin: 22px 0 28px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .section-title {
      margin: 0;
      font-size: 18px;
    }

    .timeline-container {
      display: flex;
      flex-direction: row;
      overflow-x: auto;
      overflow-y: hidden;
      gap: 16px;
      padding: 14px 6px;
      border-top: 2px solid #e7e7e7;
      scroll-behavior: smooth;
    }

    .timeline-container::-webkit-scrollbar {
      height: 6px;
    }

    .timeline-event {
      min-width: 160px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #cfcfcf;
      cursor: pointer;
      text-align: center;
      transition: transform .2s;
      white-space: normal;
    }

    .timeline-event:hover {
      transform: scale(1.04);
    }

    .timeline-year {
      font-weight: bold;
      margin-bottom: 6px;
    }

    button {
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fafafa;
    }

    /* Modal */
    .modal {
      position: fixed !important;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.45);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 18px;
      border-radius: 10px;
      width: 440px;
      max-width: 92%;
    }

    .close-btn {
      float: right;
      cursor: pointer;
      font-weight: bold;
    }

    textarea, input, select {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    .muted {
      color: #666;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .danger {
      color: #b00020;
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 6px;
    }
  </style>
</head>
<body>

<h1>Interactive Historical Timelines</h1>
<p class="subtitle">Multiple timelines rendered together. Add events to a specific timeline with one click.</p>

<div id="root"></div>

<!-- View / Edit Modal -->
<div id="eventModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeModal()">✖</span>
    <h3 id="modalTitle"></h3>
    <p class="muted"><strong>When:</strong> <span id="modalYear"></span></p>
    <p><strong>Description:</strong></p>
    <p id="modalDesc"></p>

    <div class="actions">
      <button onclick="enableEdit()">Edit</button>
      <button class="danger" onclick="confirmDelete()">Delete</button>
    </div>

    <!-- Edit Form -->
    <div id="editForm" style="display:none; margin-top: 12px;">
      <label>Timeline</label>
      <select id="editTimeline"></select>

      <label>Event Name</label>
      <input id="editName" placeholder="e.g., Coronation of ...">

      <div class="row">
        <div>
          <label>Year</label>
          <input id="editYear" type="number" placeholder="e.g., 326">
        </div>
        <div>
          <label>Era</label>
          <select id="editEra">
            <option value="BC">BC</option>
            <option value="CE">CE</option>
          </select>
        </div>
      </div>

      <label>Description</label>
      <textarea id="editDesc" rows="4" placeholder="A few lines..."></textarea>

      <div class="actions">
        <button onclick="saveChanges()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeAddModal()">✖</span>
    <h3>Add Event</h3>

    <label>Timeline</label>
    <select id="addTimeline"></select>

    <label>Event Name</label>
    <input id="addName" placeholder="Event title">

    <div class="row">
      <div>
        <label>Year</label>
        <input id="addYear" type="number" placeholder="e.g., 1200">
      </div>
      <div>
        <label>Era</label>
        <select id="addEra">
          <option value="BC">BC</option>
          <option value="CE" selected>CE</option>
        </select>
      </div>
    </div>

    <label>Description</label>
    <textarea id="addDesc" rows="4" placeholder="A few lines..."></textarea>

    <div class="actions">
      <button onclick="submitAdd()">Add</button>
    </div>
  </div>
</div>

<script>
let allTimelines = [];   // ["Timeline 1", "Timeline 2", ...]
let grouped = [];        // [{name, events:[]}, ...]
let currentEvent = null; // event object currently opened
let currentOriginal = null; // original composite key for edits/deletes

function idForTimeline(name) {
  return "tl-" + encodeURIComponent(name);
}

function openAddModal(defaultTimeline) {
  const sel = document.getElementById("addTimeline");
  sel.innerHTML = "";
  allTimelines.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    if (t === defaultTimeline) opt.selected = true;
    sel.appendChild(opt);
  });

  // Reset fields
  document.getElementById("addName").value = "";
  document.getElementById("addYear").value = "";
  document.getElementById("addEra").value = "CE";
  document.getElementById("addDesc").value = "";

  document.getElementById("addModal").style.display = "flex";
}

function closeAddModal() {
  document.getElementById("addModal").style.display = "none";
}

function submitAdd() {
  const payload = {
    timelineName: document.getElementById("addTimeline").value,
    name: document.getElementById("addName").value,
    year: document.getElementById("addYear").value,
    era: document.getElementById("addEra").value,
    description: document.getElementById("addDesc").value,
  };

  google.script.run.withSuccessHandler(res => {
    if (!res || !res.success) alert(res?.message || "Failed to add.");
    closeAddModal();
    loadAll();
  }).addEvent(payload);
}

function loadAll() {
  google.script.run.withSuccessHandler(res => {
    const root = document.getElementById("root");
    root.innerHTML = "";
    grouped = res.timelines || [];
    allTimelines = res.timelineNames || [];

    grouped.forEach(tl => {
      // Section wrapper
      const section = document.createElement("div");
      section.className = "timeline-section";

      // Header with title and per-timeline Add button
      const header = document.createElement("div");
      header.className = "section-header";

      const title = document.createElement("h2");
      title.className = "section-title";
      title.textContent = tl.name;

      const addBtn = document.createElement("button");
      addBtn.textContent = `Add Event to ${tl.name}`;
      addBtn.onclick = () => openAddModal(tl.name);

      header.appendChild(title);
      header.appendChild(addBtn);

      // Horizontal container
      const container = document.createElement("div");
      container.className = "timeline-container";
      container.id = idForTimeline(tl.name);

      // Events
      if (!tl.events || tl.events.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No events yet.";
        container.appendChild(empty);
      } else {
        tl.events.forEach(ev => {
          const card = document.createElement("div");
          card.className = "timeline-event";
          card.innerHTML = `
            <div class="timeline-year">${ev.year} ${ev.era}</div>
            <div>${ev.name}</div>
          `;
          card.onclick = () => showEvent(ev);
          container.appendChild(card);
        });
      }

      section.appendChild(header);
      section.appendChild(container);
      root.appendChild(section);
    });

    // In case there are zero timelines, allow adding to a default one
    if (allTimelines.length === 0) {
      allTimelines = ["Timeline 1"];
      const section = document.createElement("div");
      section.className = "timeline-section";
      const header = document.createElement("div");
      header.className = "section-header";
      const title = document.createElement("h2");
      title.className = "section-title";
      title.textContent = "Timeline 1";
      const addBtn = document.createElement("button");
      addBtn.textContent = "Add Event to Timeline 1";
      addBtn.onclick = () => openAddModal("Timeline 1");
      header.appendChild(title);
      header.appendChild(addBtn);
      const container = document.createElement("div");
      container.className = "timeline-container";
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "No events yet.";
      container.appendChild(empty);
      section.appendChild(header);
      section.appendChild(container);
      root.appendChild(section);
    }
  }).getEventsGrouped();
}

function showEvent(ev) {
  currentEvent = ev;
  currentOriginal = {
    timelineName: ev.timelineName,
    name: ev.name,
    year: ev.year,
    era: ev.era
  };

  document.getElementById("modalTitle").innerText = ev.name;
  document.getElementById("modalYear").innerText = `${ev.year} ${ev.era} — ${ev.timelineName}`;
  document.getElementById("modalDesc").innerText = ev.description || "";

  // Prepare edit dropdown for timelines
  const sel = document.getElementById("editTimeline");
  sel.innerHTML = "";
  allTimelines.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    if (t === ev.timelineName) opt.selected = true;
    sel.appendChild(opt);
  });

  document.getElementById("eventModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("eventModal").style.display = "none";
  document.getElementById("editForm").style.display = "none";
}

function enableEdit() {
  document.getElementById("editForm").style.display = "block";
  document.getElementById("editName").value = currentEvent.name;
  document.getElementById("editYear").value = currentEvent.year;
  document.getElementById("editEra").value = currentEvent.era;
  document.getElementById("editDesc").value = currentEvent.description || "";
  document.getElementById("editTimeline").value = currentEvent.timelineName;
}

function saveChanges() {
  const updated = {
    original: currentOriginal,
    timelineName: document.getElementById("editTimeline").value,
    name: document.getElementById("editName").value,
    year: document.getElementById("editYear").value,
    era: document.getElementById("editEra").value,
    description: document.getElementById("editDesc").value
  };

  google.script.run.withSuccessHandler(res => {
    if (!res || !res.success) alert(res?.message || "Failed to update.");
    closeModal();
    loadAll();
  }).updateEvent(updated);
}

function confirmDelete() {
  if (!confirm("Delete this event?")) return;

  const payload = {
    timelineName: currentOriginal.timelineName,
    name: currentOriginal.name,
    year: currentOriginal.year,
    era: currentOriginal.era
  };

  google.script.run.withSuccessHandler(res => {
    if (!res || !res.success) alert(res?.message || "Failed to delete.");
    closeModal();
    loadAll();
  }).deleteEvent(payload);
}

document.addEventListener("DOMContentLoaded", loadAll);
</script>
</body>
</html>
